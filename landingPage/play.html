<!DOCTYPE html>
<html lang="en">
<head>
  <title>FurQuest</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
  <link rel="stylesheet" href="homeStyles.css">
</head>
<body>

<canvas id="gameCanvas"  style="border:2px solid #FFFFFF;  position:fixed; z-index:-1; left: 450px">
</canvas>

<img id="town" src="../assets/town.png" alt="The town" style="display:none; z-index:-1">
<img id="town2" src="../assets/town2.png" alt="The town" style="display:none; z-index: -1">
</body>

<script>

var gameCanvas = document.getElementById("gameCanvas") 
gameCanvas.width = 1010
gameCanvas.height = 630
var ctx = gameCanvas.getContext("2d");
var img = document.getElementById("town");
var img2 = document.getElementById("town2");

var playerImg = new Image();
playerImg.src = "../assets/panda.png"
var playerWalkImg = new Image();
playerWalkImg.src = "../assets/pandaWalk.png"
var playerX = 950
var playerY = 400

ctx.globalCompositeOperation='source-over';
ctx.drawImage(img, 5, 5)

playerImg.onload = function(e) {
   ctx.drawImage(e.target, 500, 400, 200, 150)
}

//ctx.drawImage(playerImg, 30, 30, 0.2 ,2)
// x: 453, y: 0, top point , basically just subtract 453
enteringCoffeShop = false
function modifyScene(x, y){

  if(x > -.49 && x < -.40 && y > 0.015 && y < 0.177){
     enteringCoffeShop = true
     console.log("entering coffee shop");
     ctx.drawImage(img2, 5, 5)
	 movePlayerCof(playerX, playerY)
  }
  else{
     ctx.drawImage(img, 5, 5)
	 ctx.drawImage(playerImg, playerX - 453 - 85, playerY - 85, 200, 150)
     enteringCoffeShop = false
  }

}

var animationTick = 0;

var destX = 500
var destY = 500

var isUp = false;
var isMoving = false
var clickCount = 0
let start = -1;
var playerSpeed = .15 // .001 px per ms
var playerSpeedx = 1 // 10px/s
var playerSpeedy = 1
var oldt1x = 1;
var oldt1y = 1;
var diffX = Math.abs(destX - playerX);
var diffY = Math.abs(destY - playerY);
var diffTot = diffX + diffY 
var percentX = diffX / diffTot
var percentY = diffY / diffTot 
var playerSpeedx = playerSpeed * percentX
var playerSpeedy = playerSpeed * percentY
var diffSqX = diffX * diffX 
var diffSqY = diffY * diffY 
var totalDistancePx = Math.sqrt( diffSqX + diffSqY)
var animationTimeReq = totalDistancePx / playerSpeed
function render(time) {
  var timeS = time * 0.001;  // seconds

  if (start == -1){
    start = time
  }
  const elapsed = time - start;
  animationTick += 1
  
  
  var t1x =(playerSpeedx * elapsed);
  var t1y = (playerSpeedy * elapsed);
  //ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  
  
  ctx.drawImage(img, 5, 5)
  if(enteringCoffeShop) ctx.drawImage(img2, 5, 5)
  //ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  if(animationTick <= 15) ctx.drawImage(playerImg, playerX + t1x - 453 - 85, playerY + t1y - 85, 200, 150);
  if(animationTick > 15) {
    ctx.drawImage(playerWalkImg, playerX + t1x - 453 - 85, playerY + t1y - 85, 200, 150);
	if(animationTick == 30) animationTick = 0
  }
  
  if(clickCount > 1){
    playerX = playerX + t1x
	playerY = playerY + t1y
    clickCount = 0
	movePlayer(destX, destY)
	return;
  }
  
  if (Math.abs(Math.round(playerX + t1x,2) - Math.round(destX,2)) > 1 || 
       Math.abs(Math.round(playerY + t1y, 2) - Math.round(destY, 2)) > 1) { // Stop the animation 
    requestAnimationFrame(render);
  }else{
    console.log(elapsed)
    playerX = playerX + t1x
	playerY = playerY + t1y
	isMoving = false;
	clickCount = 0
  }
  
  
}
var wasMoving = false;
console.log(playerX)
function movePlayer(x, y){
   isMoving = true;
   destX = x 
   destY = y
   clickCount += 1;
   if(clickCount > 1) {
	 return;
   }

   console.log(clickCount)
   console.log("ll: playerX:" + playerX)
  //updateServer(x, y) store generalized coordinates here
   start = -1
  isMoving = true
  console.log('beep')
  console.log("destX:"+destX +" , destY:"+destY + "playerX:" + playerX + "playerY:" + playerY)
  if(destX == playerX && destY == playerY) return;
  //ctx.drawImage(img, 5, 5)
  diffX = Math.abs(destX - playerX);
	diffY = Math.abs(destY - playerY);
	diffTot = diffX + diffY 
	percentX = diffX / diffTot
	percentY = diffY / diffTot 
	playerSpeedx = playerSpeed * percentX
	playerSpeedy = playerSpeed * percentY
	diffSqX = diffX * diffX 
	diffSqY = diffY * diffY 
	totalDistancePx = Math.sqrt( diffSqX + diffSqY)
	animationTimeReq = totalDistancePx / playerSpeed
	console.log("speedX: " + playerSpeedx)
	console.log("speedY: " + playerSpeedy)
	console.log("animationTimeReq:" + animationTimeReq)
	console.log("totalDistancePx:" + totalDistancePx)
  if(destY < playerY) playerSpeedy *= -1
  if(destX < playerX) playerSpeedx *= -1
  requestAnimationFrame(render);
}

function movePlayerCof(x, y){
  console.log('beep')
  ctx.drawImage(img2, 5, 5)
  ctx.drawImage(playerImg, x - 453 - 85, y - 85, 200, 150)
}

gameCanvas.addEventListener("mousedown", e => { 
  console.log("moving character")
  var x = e.clientX
  var y = e.clientY
  console.log("X: "+ e.clientX)
  console.log("Y: "+ e.clientY)
  var rectangle = e.target.getBoundingClientRect(); 
	
  var x = ((x - rectangle.left)-(gameCanvas.width/2))/(gameCanvas.width/2);
  var y = ((gameCanvas.height/2)-(y-rectangle.top))/(gameCanvas.height/2);
  console.log("x: "+ x)
  console.log("y: "+ y)
  
  modifyScene(x, y)
  movePlayer(e.clientX, e.clientY)
})

gameCanvas.addEventListener("mousemove", e => { 
  var x = e.clientX
  var y = e.clientY
 // console.log("X: "+ e.clientX)
 // console.log("Y: "+ e.clientY)
  var rectangle = e.target.getBoundingClientRect(); 
	
  var x = ((x - rectangle.left)-(gameCanvas.width/2))/(gameCanvas.width/2);
  var y = ((gameCanvas.height/2)-(y-rectangle.top))/(gameCanvas.height/2);
  //console.log("x: "+ x)
 // console.log("y: "+ y)
  
  modifyScene(x, y)
})

var firebaseConfig = {
    apiKey: "AIzaSyDGPX41BsvlB0a05akJiWTS_9yH_UZO744",
    authDomain: "furquest-1c939.firebaseapp.com",
    databaseURL: "https://furquest-1c939.firebaseio.com",
    projectId: "furquest-1c939",
    storageBucket: "furquest-1c939.appspot.com",
    messagingSenderId: "178770843812",
    appId: "1:178770843812:web:f8bf303167b573f41c6e31",
    measurementId: "G-D1DXBJLC06"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.database().ref();
  
firebase.auth().onAuthStateChanged(firebaseUser => {
  if(firebaseUser){
    console.log(firebaseUser);

  }
  else{
    console.log("not logged in");
	alert("please log in")
  }
})

</script>
</html>